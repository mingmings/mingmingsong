<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/note/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/note/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/note/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/note/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/note/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/note/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/note/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="redis的复制," />










<meta name="description" content="最近碰了的一个线上问题，让我重新开始看看 redis 的复制，也算是重新认识下 redis 以及仔细了解下，话不多说，直接开始，部分内容摘抄 罗峰 的博客的这篇 redis 复制">
<meta name="keywords" content="redis的复制">
<meta property="og:type" content="article">
<meta property="og:title" content="redis 的复制">
<meta property="og:url" content="http://mingmings.org/note/db_redis的复制.html">
<meta property="og:site_name" content="异类深呼吸">
<meta property="og:description" content="最近碰了的一个线上问题，让我重新开始看看 redis 的复制，也算是重新认识下 redis 以及仔细了解下，话不多说，直接开始，部分内容摘抄 罗峰 的博客的这篇 redis 复制">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis-rep3.jpg">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis rep1.png">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis-rep2.png">
<meta property="og:image" content="http://mingmings.qiniudn.com/psync-1.png">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis 主从套接字.png">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis replication auth.png">
<meta property="og:image" content="http://mingmings.qiniudn.com/redis replication psync.png">
<meta property="og:updated_time" content="2017-04-22T07:04:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis 的复制">
<meta name="twitter:description" content="最近碰了的一个线上问题，让我重新开始看看 redis 的复制，也算是重新认识下 redis 以及仔细了解下，话不多说，直接开始，部分内容摘抄 罗峰 的博客的这篇 redis 复制">
<meta name="twitter:image" content="http://mingmings.qiniudn.com/redis-rep3.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/note/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mingmings.org/note/db_redis的复制.html"/>





  <title>redis 的复制 | 异类深呼吸</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/note/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">异类深呼吸</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/note/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/note/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/note/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/note/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', '2XUreAeRFh7MepgoTDCi','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mingmings.org/note/note/db_redis的复制.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="宋大明明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/note/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="异类深呼吸">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">redis 的复制</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-13T19:19:55+08:00">
                2014-12-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/note/categories/DB/" itemprop="url" rel="index">
                    <span itemprop="name">DB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/note/db_redis的复制.html#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="db_redis的复制.html" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近碰了的一个线上问题，让我重新开始看看 redis 的复制，也算是重新认识下 redis 以及仔细了解下，话不多说，直接开始，部分内容摘抄 <a href="http://cfwlxf.blog.51cto.com/3966339/1433637" target="_blank" rel="noopener">罗峰</a> 的博客的这篇 redis 复制<br><a id="more"></a></p>
<h2 id="一、什么是复制"><a href="#一、什么是复制" class="headerlink" title="一、什么是复制"></a>一、什么是复制</h2><p>主从复制，当用户往 Master 端写入数据时，通过 <code>Redis Sync</code> 机制将数据文件发送至 Slave，Slave 也会执行相同的操作确保数据一致；且实现 Redis 的主从复制非常简单。</p>
<h2 id="二、redis-复制的特点"><a href="#二、redis-复制的特点" class="headerlink" title="二、redis 复制的特点"></a>二、redis 复制的特点</h2><ul>
<li><p>1、同一个 Master 可以拥有多个 Slaves。</p>
</li>
<li><p>2、Master 下的 Slave 还可以接受同一架构中其它 slave 的链接与同步请求，实现数据的级联复制，即 <code>Master-&gt;Slave-&gt;Slave</code> 模式；</p>
</li>
<li><p>3、Master 以非阻塞的方式同步数据至 slave，这将意味着 Master 会继续处理一个或多个 slave 的读写请求；</p>
</li>
<li><p>4、Slave 端同步数据也可以修改为非阻塞是的方式，当 slave 在执行新的同步时，它仍可以用旧的数据信息来提供查询；否则，当 slave 与 master 失去联系时，slave 会返回一个错误给客户端；</p>
</li>
<li><p>5、主从复制具有可扩展性，即多个 slave 专门提供只读查询与数据的冗余，Master 端专门提供写操作；</p>
</li>
<li><p>6、通过配置禁用 Master 数据持久化机制，将其数据持久化操作交给 Slaves 完成，避免在 Master 中要有独立的进程来完成此操作。</p>
</li>
</ul>
<h2 id="三、redis-复制原理"><a href="#三、redis-复制原理" class="headerlink" title="三、redis 复制原理"></a>三、redis 复制原理</h2><h4 id="3-1-主从复制原理"><a href="#3-1-主从复制原理" class="headerlink" title="3.1 主从复制原理"></a>3.1 主从复制原理</h4><p><img src="http://mingmings.qiniudn.com/redis-rep3.jpg" alt="redis replication"><br>允许我可耻的把大峰哥的图也扒下来了，大致的复制过程入上图。</p>
<p>当启动一个 Slave 进程后，它会向 Master 发送一个 SYNC Command，请求同步连接。无论是第一次连接还是重新连接，Master 都会启动一个后台进程，将数据快照保存到数据文件中，同时 Master 会记录所有修改数据的命令并缓存在数据文件中。具体处理函数如下图<br><img src="http://mingmings.qiniudn.com/redis rep1.png" alt="redis replication1"></p>
<p>后台进程完成缓存操作后，Master 就发送数据文件给 Slave，Slave 端将数据文件保存到硬盘上，然后将其在加载到内存中，接着 Master 就会所有修改数据的操作，将其发送给 Slave 端。若 Slave 出现故障导致宕机，恢复正常后会自动重新连接，Master 收到 Slave 的连接后，将其完整的数据文件发送给 Slave，如果 Mater 同时收到多个 Slave 发来的同步请求，Master 只会在后台启动一个进程保存数据文件，然后将其发送给所有的 Slave，确保Slave 正常。下面来个详细版的全图<br><img src="http://mingmings.qiniudn.com/redis-rep2.png" alt="redis replication2"></p>
<h4 id="3-2-补充"><a href="#3-2-补充" class="headerlink" title="3.2 补充"></a>3.2 补充</h4><blockquote>
<p>redis 2.8 版本之后，主从同步机制发生了一些变化，参考阅读《redis 设计与实现》第二版</p>
</blockquote>
<p>redis 复制功能分为同步（sync）和命令传播（command propagate）两个操作</p>
<ul>
<li>同步将从 slave 数据库状态更新至和 master 当前的数据库状态</li>
<li>命令传播则用于在 master 状态被修改，导致主从不一致时候，让主从重新回到一直的状态的作用</li>
</ul>
<blockquote>
<p>旧版本复制功能的缺陷</p>
</blockquote>
<ul>
<li><p>初次复制<br>slave 之前没有复制过任何 master，或者当 slave 当前要复制的 master 和上次复制的 master 不同</p>
</li>
<li><p>断线后重新复制：<br>处于命令传播阶段的 master 因为一些原因中断了复制，但是 slave 通过自动重连连接上了 master，并继续复制 master。虽然断线后重连，但是 master 会向 slave 从头发送一份包含所有 key 的 rdb 文件给 slave，而往往 slave 中已经包含了部分 key。为了弥补断线产生的丢失的数据，重新连线上来的 slave， master 重新又做一次完整的 sync 无疑是非常低效的</p>
</li>
</ul>
<blockquote>
<p>先来看看 fsync 做了什么</p>
</blockquote>
<p>每次执行 fsync 命令，redis 得做如下事情</p>
<ul>
<li>master 需要执行 BGSAVE 命令来生成 RDB 文件，这个生成操作会耗费 master 大量的 CPU、内存和磁盘 I/O 资源</li>
<li>master 要讲自己生成的 RDB 文件发送给 slave ，这个发送会耗费大量的网络带宽和流量，并且对 master 服务响应产生一定的影响</li>
<li>slave 接受到了这个 RDB，需要重载，载入期间会阻塞没法处理请求</li>
</ul>
<p>所以综上 fsync 是一个相当耗费资源的操作</p>
<blockquote>
<p>redis 2.8 + 新版本的复制功能</p>
</blockquote>
<p>所以新版本处理断线重连那个机制上用 <code>psync</code> 命令替换了原有的 <code>fsync</code></p>
<h4 id="3-2-psync"><a href="#3-2-psync" class="headerlink" title="3.2 psync"></a>3.2 psync</h4><blockquote>
<p>psync 具备 <code>完整同步</code> 和 <code>部分同步</code> 两种模式</p>
</blockquote>
<ul>
<li><p>完整同步：<br>用于 slave 第一次进行复制的时候，这个时候和 fsync 效果是一样的，一次完整的 fsync ，发送完整的 RDB 文件，以及发送缓冲区的命令等</p>
</li>
<li><p>部分同步：<br>部分同步用于处理断线后重连的情况，当 slave 断线重连后，如果条件合适，master 只发送断线期间的写操作命令给 slave，下面用一个图简单解释下 psync 工作过程<br><img src="http://mingmings.qiniudn.com/psync-1.png" alt="psync 工作过程"></p>
</li>
<li><p>psync 部分模式有下面几个部分组成</p>
<ul>
<li>master 复制偏移量（replication offset）：</li>
<li>master 复制积压缓冲区（replication backlog）</li>
<li>服务器运行 ID（run id）</li>
</ul>
</li>
</ul>
<blockquote>
<p>就是这个部分同步解决了 2.8 版本之前旧复制模式的缺陷，具体的 pysnc 实现过程，可以阅读《redis 设计与实现》中有更为详细的说明</p>
</blockquote>
<h4 id="3-3-主从同步的过程"><a href="#3-3-主从同步的过程" class="headerlink" title="3.3 主从同步的过程"></a>3.3 主从同步的过程</h4><p>根据 2.8 之后的改进完整的列出 2.8 版本之后的主从同步概况</p>
<blockquote>
<p>1、设置 master 地址和端口</p>
</blockquote>
<p>当 slave 接受到从客户端设置 <code>slaveof</code> 之后，或者启动配置文件里指定之后，将会把 IP 和端口保存在服务器状态的 <code>master host</code> 属性和 <code>masterport</code> 属性里，并且向客户端返回 ok</p>
<blockquote>
<p>2、建立套接字连接</p>
</blockquote>
<p>slaveof 命令执行之后，slave 根据命令所设置，创建连向 master 的套接字连接。一旦套接字成功连接，slave 会为复制分配一个文件事件处理器处理后续复制相关工作，master 则会把 slave 看做是自己的客户端对待，具体流程如下图<br><img src="http://mingmings.qiniudn.com/redis 主从套接字.png" alt="redis 主从套接字"></p>
<blockquote>
<p>3、发送 PING 命令</p>
</blockquote>
<p>当套接字建立后，第一件事 slave 机会向 master 发送一个 PING 命令，这个命令有如下作用</p>
<ul>
<li><p>检测套接字读写是否正常</p>
</li>
<li><p>检测 master 是否能正常处理请求</p>
</li>
<li><p>如果 master 响应并返回命令回复，但是 slave 没法在规定时间读取命令回复内容，表示主从网络状态不佳，出现这种情况，slave 会断开并重新创建连向 master 的套接字</p>
</li>
<li><p>如果 master 响应并返回一个错误，表示 master 暂且没法处理 slave 的命令请求，不能继续执行复制工作的后续，当出现这种情况，slave 断开并重新创建连向 master 的套接字。</p>
</li>
<li><p>如果 slave 接受到 PONG 回复，表示主从网络状态正常，可以正常处理 slave 的请求，复制可以继续</p>
</li>
</ul>
<blockquote>
<p>4、身份验证</p>
</blockquote>
<p>收到 <code>PONG</code> 之后，就进入身份验证阶段</p>
<ul>
<li><p>如果 slave 设置了 <code>masterauth</code> 则进行身份验证</p>
</li>
<li><p>如果 slave 没设置，那么不进行验证</p>
</li>
</ul>
<p>需要身份验证的情况下，slave 向 master 发送一条 <code>AUTH</code> 命令，命令参数为 slave 设置的 <code>masterauth</code> 选项的值，验证阶段可能碰到一下情况</p>
<ul>
<li><p>如果 master 没有配置 <code>requirepass</code> 选项，并且 slave 上也没有设置 <code>masterauth</code> 那么就没有验证，复制工作继续执行</p>
</li>
<li><p>如果 slave 发送了 <code>AUTH</code> 命令发送的密码和 master 上配置的相同，通过验证，复制继续，如果密码错误，返回 <code>invalid password</code></p>
</li>
<li><p>如果 master 设置了 <code>requirepass</code> 选项，slave 没有设置 <code>masterauth</code> 选项，那么 master 会返回一个 <code>NOAUTH</code> 错误</p>
</li>
<li><p>如果 master 没设置 <code>requirepass</code> 选项，但是 slave 却设置了 <code>masterauth</code> 选项，那么 master 又会返回 <code>no password is set</code> 错误，一旦出现错误，主从复制不执行<br><img src="http://mingmings.qiniudn.com/redis replication auth.png" alt="replication auth"></p>
</li>
</ul>
<blockquote>
<p>5、发送端口信息</p>
</blockquote>
<ul>
<li><p>身份验证通过之后，slave 将执行命令 <code>REPLCONF listening-port *</code> 向 master 发送自己的监听端口号</p>
</li>
<li><p>master 接受到这个命令后，会将端口号记录在 slave 对应的客户端状态的 <code>slave_listening-port</code> 属性里，该属性可以通过客户端命令查看</p>
</li>
</ul>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:7000</span>&gt; <span class="selector-tag">INFO</span> <span class="selector-tag">replication</span></span><br><span class="line"># <span class="selector-tag">Replication</span></span><br><span class="line"><span class="selector-tag">role</span><span class="selector-pseudo">:slave</span></span><br><span class="line"><span class="selector-tag">master_host</span><span class="selector-pseudo">:127.0.0.1</span></span><br><span class="line"><span class="selector-tag">master_port</span><span class="selector-pseudo">:6000</span></span><br><span class="line"><span class="selector-tag">master_link_status</span><span class="selector-pseudo">:up</span></span><br><span class="line"><span class="selector-tag">master_last_io_seconds_ago</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">master_sync_in_progress</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">slave_repl_offset</span><span class="selector-pseudo">:29</span></span><br><span class="line"><span class="selector-tag">slave_priority</span><span class="selector-pseudo">:100</span></span><br><span class="line"><span class="selector-tag">slave_read_only</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-tag">connected_slaves</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">master_repl_offset</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_active</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_size</span><span class="selector-pseudo">:1048576</span></span><br><span class="line"><span class="selector-tag">repl_backlog_first_byte_offset</span><span class="selector-pseudo">:0</span></span><br><span class="line"><span class="selector-tag">repl_backlog_histlen</span><span class="selector-pseudo">:0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>6、同步</p>
</blockquote>
<p>这一步，slave 将向 master 发送 PSYNC 命令，执行同步操作，将自己的状态更新至和 master 当前所处的状态，这里有两种状态的变化</p>
<ul>
<li><p>如果 psync 命令执行的是完整同步操作，那么 master 需要成为 slave 的客户端，才能将保存在缓冲区里面的写命令发送给 slave</p>
</li>
<li><p>如果 psync 命令执行的是部分同步操作，那么 master 必须成为 slave 的客户端，才能向 slave 发送复制积压缓冲区的写命令</p>
</li>
</ul>
<p>这里可以用下图表明两者状态的变化<br><img src="http://mingmings.qiniudn.com/redis replication psync.png" alt="redis replication psync"></p>
<blockquote>
<p>7、命令传播</p>
</blockquote>
<p>完成同步之后，master 就会进入命令传播阶段，这时候 master 只要一直将自己执行的写命令发送给 slave，slave 只要一直接受并执行 master 发送来的写命令，就可以保证主从服务器保持一致了</p>
<h2 id="四、主从复制"><a href="#四、主从复制" class="headerlink" title="四、主从复制"></a>四、主从复制</h2><h4 id="4-1、slave"><a href="#4-1、slave" class="headerlink" title="4.1、slave"></a>4.1、slave</h4><blockquote>
<p>下面用两台 redis 来验证上面的理论，这里采用 redis 2.8.20 作为演示版本</p>
</blockquote>
<p>主从配置比较简单，一种直接写配置文件，一种直接命令行配置</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">1、命令行</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SLAVEOF</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.128</span> 6379</span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line"></span><br><span class="line">2、配置文件</span><br><span class="line"># <span class="selector-tag">slaveof</span> &lt;<span class="selector-tag">masterip</span>&gt;&lt;<span class="selector-tag">masterport</span>&gt;</span><br><span class="line"><span class="selector-tag">slaveof</span> 192<span class="selector-class">.168</span><span class="selector-class">.8</span><span class="selector-class">.8</span> 6379</span><br></pre></td></tr></table></figure>
<p>这样一个主从复制就配置完成了，当然了这个肯定不行，刚才前台输出信息，可以看到一旦配置了 slaveof 之后就会出现如下信息</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:01.341</span> * <span class="selector-tag">SLAVE</span> <span class="selector-tag">OF</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.128</span><span class="selector-pseudo">:6379</span> <span class="selector-tag">enabled</span> (<span class="selector-tag">user</span> <span class="selector-tag">request</span>)</span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.309</span> * <span class="selector-tag">Connecting</span> <span class="selector-tag">to</span> <span class="selector-tag">MASTER</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.128</span><span class="selector-pseudo">:6379</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.309</span> * <span class="selector-tag">MASTER</span> &lt;<span class="selector-tag">-</span>&gt; <span class="selector-tag">SLAVE</span> <span class="selector-tag">sync</span> <span class="selector-tag">started</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.310</span> * <span class="selector-tag">Non</span> <span class="selector-tag">blocking</span> <span class="selector-tag">connect</span> <span class="selector-tag">for</span> <span class="selector-tag">SYNC</span> <span class="selector-tag">fired</span> <span class="selector-tag">the</span> <span class="selector-tag">event</span>.</span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.311</span> * <span class="selector-tag">Master</span> <span class="selector-tag">replied</span> <span class="selector-tag">to</span> <span class="selector-tag">PING</span>, <span class="selector-tag">replication</span> <span class="selector-tag">can</span> <span class="selector-tag">continue</span>...</span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.311</span> * <span class="selector-tag">Partial</span> <span class="selector-tag">resynchronization</span> <span class="selector-tag">not</span> <span class="selector-tag">possible</span> (<span class="selector-tag">no</span> <span class="selector-tag">cached</span> <span class="selector-tag">master</span>)</span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.312</span> * <span class="selector-tag">Full</span> <span class="selector-tag">resync</span> <span class="selector-tag">from</span> <span class="selector-tag">master</span>: 0<span class="selector-tag">d7eef5f1941e4d09e10caa02d27094ff785ca42</span><span class="selector-pseudo">:1</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.411</span> * <span class="selector-tag">MASTER</span> &lt;<span class="selector-tag">-</span>&gt; <span class="selector-tag">SLAVE</span> <span class="selector-tag">sync</span>: <span class="selector-tag">receiving</span> 18 <span class="selector-tag">bytes</span> <span class="selector-tag">from</span> <span class="selector-tag">master</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.412</span> * <span class="selector-tag">MASTER</span> &lt;<span class="selector-tag">-</span>&gt; <span class="selector-tag">SLAVE</span> <span class="selector-tag">sync</span>: <span class="selector-tag">Flushing</span> <span class="selector-tag">old</span> <span class="selector-tag">data</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.412</span> * <span class="selector-tag">MASTER</span> &lt;<span class="selector-tag">-</span>&gt; <span class="selector-tag">SLAVE</span> <span class="selector-tag">sync</span>: <span class="selector-tag">Loading</span> <span class="selector-tag">DB</span> <span class="selector-tag">in</span> <span class="selector-tag">memory</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.412</span> * <span class="selector-tag">MASTER</span> &lt;<span class="selector-tag">-</span>&gt; <span class="selector-tag">SLAVE</span> <span class="selector-tag">sync</span>: <span class="selector-tag">Finished</span> <span class="selector-tag">with</span> <span class="selector-tag">success</span></span><br></pre></td></tr></table></figure>
<h4 id="4-2、master-上"><a href="#4-2、master-上" class="headerlink" title="4.2、master 上"></a>4.2、master 上</h4><blockquote>
<p>刚才的 slave 配置之后就可以看到 master 也输出了信息，我们看到互相对应</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.308</span> * <span class="selector-tag">Slave</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.129</span><span class="selector-pseudo">:6379</span> <span class="selector-tag">asks</span> <span class="selector-tag">for</span> <span class="selector-tag">synchronization</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.308</span> * <span class="selector-tag">Full</span> <span class="selector-tag">resync</span> <span class="selector-tag">requested</span> <span class="selector-tag">by</span> <span class="selector-tag">slave</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.129</span><span class="selector-pseudo">:6379</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.309</span> * <span class="selector-tag">Starting</span> <span class="selector-tag">BGSAVE</span> <span class="selector-tag">for</span> <span class="selector-tag">SYNC</span> <span class="selector-tag">with</span> <span class="selector-tag">target</span>: <span class="selector-tag">disk</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.309</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">started</span> <span class="selector-tag">by</span> <span class="selector-tag">pid</span> 4065</span><br><span class="line"><span class="selector-attr">[4065]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.320</span> * <span class="selector-tag">DB</span> <span class="selector-tag">saved</span> <span class="selector-tag">on</span> <span class="selector-tag">disk</span></span><br><span class="line"><span class="selector-attr">[4065]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.321</span> * <span class="selector-tag">RDB</span>: 0 <span class="selector-tag">MB</span> <span class="selector-tag">of</span> <span class="selector-tag">memory</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">copy-on-write</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.408</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">terminated</span> <span class="selector-tag">with</span> <span class="selector-tag">success</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 19<span class="selector-pseudo">:11</span><span class="selector-pseudo">:02.408</span> * <span class="selector-tag">Synchronization</span> <span class="selector-tag">with</span> <span class="selector-tag">slave</span> 172<span class="selector-class">.16</span><span class="selector-class">.178</span><span class="selector-class">.129</span><span class="selector-pseudo">:6379</span> <span class="selector-tag">succeeded</span></span><br></pre></td></tr></table></figure>
<h4 id="4-3、数据同步"><a href="#4-3、数据同步" class="headerlink" title="4.3、数据同步"></a>4.3、数据同步</h4><blockquote>
<p>这里演示的库是空，master 上增加 key 操作，查看输出日志</p>
</blockquote>
<p>master 上会出现如下输出<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.454</span> * 1 <span class="selector-tag">changes</span> <span class="selector-tag">in</span> 3600 <span class="selector-tag">seconds</span>. <span class="selector-tag">Saving</span>...</span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.455</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">started</span> <span class="selector-tag">by</span> <span class="selector-tag">pid</span> 4122</span><br><span class="line"><span class="selector-attr">[4122]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.457</span> * <span class="selector-tag">DB</span> <span class="selector-tag">saved</span> <span class="selector-tag">on</span> <span class="selector-tag">disk</span></span><br><span class="line"><span class="selector-attr">[4122]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.458</span> * <span class="selector-tag">RDB</span>: 0 <span class="selector-tag">MB</span> <span class="selector-tag">of</span> <span class="selector-tag">memory</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">copy-on-write</span></span><br><span class="line"><span class="selector-attr">[4025]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.556</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">terminated</span> <span class="selector-tag">with</span> <span class="selector-tag">success</span></span><br></pre></td></tr></table></figure></p>
<p>slave 上的信息<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.465</span> * 1 <span class="selector-tag">changes</span> <span class="selector-tag">in</span> 3600 <span class="selector-tag">seconds</span>. <span class="selector-tag">Saving</span>...</span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.467</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">started</span> <span class="selector-tag">by</span> <span class="selector-tag">pid</span> 4240</span><br><span class="line"><span class="selector-attr">[4240]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.477</span> * <span class="selector-tag">DB</span> <span class="selector-tag">saved</span> <span class="selector-tag">on</span> <span class="selector-tag">disk</span></span><br><span class="line"><span class="selector-attr">[4240]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.477</span> * <span class="selector-tag">RDB</span>: 0 <span class="selector-tag">MB</span> <span class="selector-tag">of</span> <span class="selector-tag">memory</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">copy-on-write</span></span><br><span class="line"><span class="selector-attr">[4161]</span> 30 <span class="selector-tag">May</span> 20<span class="selector-pseudo">:46</span><span class="selector-pseudo">:48.568</span> * <span class="selector-tag">Background</span> <span class="selector-tag">saving</span> <span class="selector-tag">terminated</span> <span class="selector-tag">with</span> <span class="selector-tag">success</span></span><br></pre></td></tr></table></figure></p>
<p>上面这两段信息即可验证了上面的理论，也同时看到数据同步到 slave 上，完成了一次复制操作</p>
<h2 id="五、读写分离和安全"><a href="#五、读写分离和安全" class="headerlink" title="五、读写分离和安全"></a>五、读写分离和安全</h2><h4 id="5-1-读写分离"><a href="#5-1-读写分离" class="headerlink" title="5.1 读写分离"></a>5.1 读写分离</h4><ul>
<li>通过复制可以实现读写分离提高服务器负载能力，master 只负责写，多个 slave 可以负责读</li>
<li>并且 master 上禁用持久化，slave 上开启持久化</li>
</ul>
<h4 id="5-2-安全"><a href="#5-2-安全" class="headerlink" title="5.2 安全"></a>5.2 安全</h4><p>1、绑定信任地址</p>
<p>redis 是设计是在 “redis 运行在可信环境” 前提下做出的，所以默认 redis 会接受来自任何地址发送过来的请求，可以通过 bind 实现绑定地址</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">bind</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">X</span><span class="selector-class">.X</span><span class="selector-class">.X</span><span class="selector-class">.X</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.8 之前的版本只能绑定一个地址，2.8 之后的版本可以绑定多个地址</p>
</blockquote>
<p>2、为 redis 设置一个密码</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">requirepass <span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样客户端每次连接都需要输入 <code>&gt; AUTH ***********</code> 才可以正常连接使用</p>
</blockquote>
<p>如果上面的配置是在主从环境下的 master 上，那么 slave 也必须在配置里写明才能正常的复制 master</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">masterauth <span class="strong">*****</span><span class="strong">*****</span>**</span><br></pre></td></tr></table></figure>
<p>3、特殊命令设置别名</p>
<p>有些特殊的命令，如 <code>FLUSHALL</code> 这类命令相当危险，可以设置一个复杂的别名，可以将此别名写入程序调用，这样手动输出命中的概率很低</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rename</span>-<span class="keyword">command</span> <span class="title">FLUSHALL</span> <span class="title">kafhksdhfkhsakfhasdklhfklsa</span></span><br></pre></td></tr></table></figure>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="http://cfwlxf.blog.51cto.com/3966339/1433637" target="_blank" rel="noopener">redis主从复制</a></li>
<li><a href="http://redis.readthedocs.org/en/latest/topic/replication.html" target="_blank" rel="noopener">redis replication 中文</a></li>
<li><a href="http://redis.io/topics/replication" target="_blank" rel="noopener">redis replication doc</a></li>
<li>《redis 设计与实现》第二版</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/note/tags/redis的复制/" rel="tag"> redis的复制</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/note/云_AWS-Command-Line-Interface.html" rel="next" title="AWS Command Line Interface">
                <i class="fa fa-chevron-left"></i> AWS Command Line Interface
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/note/云_AWS-API-boto采坑.html" rel="prev" title="AWS API boto采坑">
                AWS API boto采坑 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">宋大明明</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/note/archives">
              
                  <span class="site-state-item-count">78</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/note/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/note/tags/index.html">
                  <span class="site-state-item-count">104</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、什么是复制"><span class="nav-number">1.</span> <span class="nav-text">一、什么是复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、redis-复制的特点"><span class="nav-number">2.</span> <span class="nav-text">二、redis 复制的特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、redis-复制原理"><span class="nav-number">3.</span> <span class="nav-text">三、redis 复制原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-主从复制原理"><span class="nav-number">3.0.1.</span> <span class="nav-text">3.1 主从复制原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-补充"><span class="nav-number">3.0.2.</span> <span class="nav-text">3.2 补充</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-psync"><span class="nav-number">3.0.3.</span> <span class="nav-text">3.2 psync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-主从同步的过程"><span class="nav-number">3.0.4.</span> <span class="nav-text">3.3 主从同步的过程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、主从复制"><span class="nav-number">4.</span> <span class="nav-text">四、主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1、slave"><span class="nav-number">4.0.1.</span> <span class="nav-text">4.1、slave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2、master-上"><span class="nav-number">4.0.2.</span> <span class="nav-text">4.2、master 上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3、数据同步"><span class="nav-number">4.0.3.</span> <span class="nav-text">4.3、数据同步</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、读写分离和安全"><span class="nav-number">5.</span> <span class="nav-text">五、读写分离和安全</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-读写分离"><span class="nav-number">5.0.1.</span> <span class="nav-text">5.1 读写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-安全"><span class="nav-number">5.0.2.</span> <span class="nav-text">5.2 安全</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考链接"><span class="nav-number">5.1.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">宋大明明</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/note/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/note/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/note/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/note/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/note/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/note/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/note/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/note/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/note/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/note/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/note/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cysXpXYKk';
      var conf = 'prod_5e8c79789369e2fd960db50f54408e02';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  









  





  

  

  

  
  

  

  

  


</body>
</html>
